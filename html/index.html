<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Abstractify</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/assets/pico.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/notie/dist/notie.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cedarville+Cursive&display=swap" rel="stylesheet">
    <style>
      .notie-container{
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <section>
        <div id="intro">
          <a href="/" style="color: black; text-decoration: none;"><h1 style="font-family: 'Cedarville Cursive', cursive;">Abstractify</h1></a>
          <img src="/assets/wallpaper.png" alt="sample image">
        </div>
      </section>
      <section>
        <div id="form">
          <p>Abstractify is a simple app that creates an abstracted version of your image.</p>
          <p>Give it a try!</p> 
          <form id="form" action="/upload" enctype="multipart/form-data" method="POST" >
            <div>
              <img id="preview" />
            </div>
            <div>
                <input id="upload" type="file" name="uploadFile" />
            </div>
            <div>
              <p>Make sure that your image file is either a JPG or PNG file and less than 4 in size. <br><br>Note that the image will be scaled to a maximum width of 1080px, which should still be sufficient for most purposes (like social media or small prints).</p> 
              <button type="submit" id="submit">Submit</button>
            </div>
          </form>
        </div>
      </section>
    </main>
    {{template "footer"}}
    <script>
      let btn = document.getElementById("submit");
      btn.addEventListener("click", () => {
        let txt = btn.innerText;
        txt = 'Please wait while your image is being processed...\n(this might take a while, depending on the resolution of your image)';
        btn.setAttribute("aria-busy", "true");
        btn.innerText = txt;
      });
      
      let uploadFile = document.getElementById("upload");
      uploadFile.addEventListener("change", () => {
        let file = uploadFile.files;
        if (file.length > 0) {
          const fileType = file[0].type;
          if (fileType != "image/jpeg" && fileType != "image/png") {
            notie.alert({type: 'error', text:'The selected file does not seem to be an image file. Please try another file.'})
            return btn.disabled = true;
            } else {
                btn.disabled = false;
          }
          const fileSize = file[0].size;
          const fileSizeMB = Math.round((fileSize/1024/1024));
            if (fileSizeMB > 4) {
            notie.alert({type: 'error', text:'The selected file exceeds 4mb in size. Please select a smaller file.'})
              return btn.disabled = true;
            } else {
                btn.disabled = false;
            }

          let imageFile = file[0];
          var reader = new FileReader();
              reader.onload = (e) => {
              var img = document.createElement("img");
                  img.onload = (event) => {
                    var MAX_WIDTH = 640;
                    var width = img.width;
                    var height = img.height;

                    if (width > MAX_WIDTH) {
                      height = height * (MAX_WIDTH/width);
                      width = MAX_WIDTH;
                    }

                    // Dynamically create a canvas element
                    var canvas = document.createElement("canvas");
                    canvas.width = width;
                    canvas.height = height;

                    // var canvas = document.getElementById("canvas");
                    var ctx = canvas.getContext("2d");

                    // Actual resizing
                    ctx.drawImage(img, 0, 0, width, height);

                    // Show resized image in preview element
                    var dataurl = canvas.toDataURL(imageFile.type);
                    document.getElementById("preview").src = dataurl;
                  }
              img.src = e.target.result;
            }
          reader.readAsDataURL(imageFile);
        } 
      });
    </script>
    <script src="https://unpkg.com/notie"></script>
  </body>
</html>
